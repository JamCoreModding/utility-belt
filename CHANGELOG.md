Code reworks and port to 1.21.10.
